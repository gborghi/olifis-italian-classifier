<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Builder, che attinge dai quesiti delle gare dei campionati di Fisica AIF</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      .spinner-border {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h2 class="text-center mb-4">Quiz Builder, che attinge dai quesiti delle gare dei campionati di Fisica AIF</h2>
      <form id="quizForm">
        <div class="row">
          <!-- Year Selection -->
          <div class="col-md-3">
            <h3>Select Years</h3>
            <div class="row">
              <div class="col-md-4">
                <div id="yearSelection1" class="form-check"></div>
              </div>
              <div class="col-md-4">
                <div id="yearSelection2" class="form-check"></div>
              </div>
              <div class="col-md-4">
                <div id="yearSelection3" class="form-check"></div>
              </div>
            </div>
          </div>
          <!-- Group Input -->
          <div class="col-md-9">
            <h3>Select Groups</h3>
            <div id="groupSelection" class="form-check">
              <!-- Populated dynamically -->
            </div>
          </div>
        </div>
        <div class="row mt-4">
          <div class="col-md-6">
            <button type="submit" class="btn btn-primary btn-block" id="submitButton">Generate Quiz</button>
          </div>
          <div class="col-md-6">
            <button class="btn btn-secondary btn-block" id="generateDocButton">Generate Problems Doc</button>
          </div>
        </div>
        <div class="text-center mt-3">
          <div class="spinner-border text-primary" id="loadingSpinner" role="status" style="display: none;">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </form>
      <!-- Result Display -->
      <div id="result" class="mt-4"></div>      
    </div>
    <footer class="m-3 p-3">
      Web app e analisi dati realizzati da Giovanni Borghi, prof di matematica e fisica @ Liceo Wiligelmo, Modena. Quesiti prodotti da AIF, Associazione per l'insegnamento della Fisica, e reperibili anche sul <a href="https://www.olifis.it/index.php/problemi-olifis" target="_blank">sito delle olimpiadi di Fisica</a>.
    </footer>
    <script>
      $(document).ready(function () {
        // Fetch available years and groups dynamically
        google.script.run.withSuccessHandler(function (data) {
          // Distribute years into three subcolumns
          const years = data.years;
          const yearColumns = ["#yearSelection1", "#yearSelection2", "#yearSelection3"];
          years.forEach((year, index) => {
            $(yearColumns[Math.floor( index / (Math.ceil(years.length / 3)))]).append(
              `<label class="form-check-label">
                <input type="checkbox" class="form-check-input" name="year" value="${year}"> ${year}
              </label><br>`
            );
          });

          // Populate group checkboxes with labels
          google.script.run.withSuccessHandler(function (groupLabels) {
            groupLabels.forEach(group => {
              $("#groupSelection").append(
                `<label class="form-check-label">
                  <input type="checkbox" class="form-check-input" name="group" value="${group.number}"> ${group.label}
                </label><br>`
              );
            });
          }).getGroupLabels();
        }).getAvailableYearsAndGroups();

        $('#quizForm').on('submit', function (e) {
          e.preventDefault();

          // Collect selected years
          const years = $('input[name="year"]:checked')
            .map(function () {
              return $(this).val();
            })
            .get()
            .join(',');

          // Collect selected groups
          const groups = $('input[name="group"]:checked')
            .map(function () {
              return $(this).val();
            })
            .get()
            .join(',');

          if (!years || !groups) {
            $('#result').html('<div class="alert alert-danger">Please select at least one year and one group.</div>');
            return;
          }

          // Show loading spinner and disable button
          $('#loadingSpinner').show();
          $('#submitButton').prop('disabled', true);
          $('#result').empty(); // Clear previous result

          // Call the Apps Script function
          google.script.run
            .withSuccessHandler(function (url) {
              $('#loadingSpinner').hide();
              $('#submitButton').prop('disabled', false);
              $('#result').html(`<div class="alert alert-success">Quiz created! <a href="${url}" target="_blank">Open Quiz</a></div>`);
            })
            .withFailureHandler(function (error) {
              $('#loadingSpinner').hide();
              $('#submitButton').prop('disabled', false);
              $('#result').html(`<div class="alert alert-danger">Error: ${error.message}</div>`);
            })
            .generateQuiz({ years, groups });
        });

        $('#generateDocButton').on('click', function (e) {
          e.preventDefault();

          const years = $('input[name="year"]:checked')
            .map(function () { return $(this).val(); })
            .get()
            .join(',');

          const groups = $('input[name="group"]:checked')
            .map(function () { return $(this).val(); })
            .get()
            .join(',');

          if (!years || !groups) {
            $('#result').html('<div class="alert alert-danger">Please select at least one year and one group.</div>');
            return;
          }

          $('#loadingSpinner').show();
          $('#submitButton').prop('disabled', true);
          $('#generateDocButton').prop('disabled', true);
          $('#result').empty();

          google.script.run
            .withSuccessHandler(function (result) {
              $('#loadingSpinner').hide();
              $('#submitButton').prop('disabled', false);
              $('#generateDocButton').prop('disabled', false);
              let html = `<div class="alert alert-success">Problems Doc created! <a href="${result.problemsUrl}" target="_blank">Open Problems Doc</a></div>`;
              if (result.solutionsUrl) {
                html += `<div class="alert alert-success">Solutions Doc created! <a href="${result.solutionsUrl}" target="_blank">Open Solutions Doc</a></div>`;
              }
              $('#result').html(html);
            })
            .withFailureHandler(function (error) {
              $('#loadingSpinner').hide();
              $('#submitButton').prop('disabled', false);
              $('#generateDocButton').prop('disabled', false);
              $('#result').html(`<div class="alert alert-danger">Error: ${error.message}</div>`);
            })
            .generateProblems({ years, groups });
        });
      });
    </script>
  </body>
</html>
